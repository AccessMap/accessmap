version: '3.2'

services:

  rakamdb:
    image: postgres:9.6.1

  rakam:
    build: ./builds/rakam
    depends_on:
      - rakamdb
    environment:
      - WAITFOR=rakamdb:5432

  fetch_and_tippecanoe:
    build: ./builds/tippecanoe-curl
    entrypoint: sh /fetch_and_build_tiles.sh /home/tippecanoe/data
    volumes:
      - ./scripts/fetch_and_build_tiles.sh:/fetch_and_build_tiles.sh
      - ${AM_DATADIR:-/docker/amdata}:/home/tippecanoe/data

  api_build:
    build:
      context: https://github.com/accessmap/accessmap-api.git#develop
    depends_on:
      - fetch_and_tippecanoe
    command: python build.py
    volumes:
      - ${AM_DATADIR:-/docker/amdata}:/www/data
      - ./config/layers.json:/www/layers.json

  api:
    build:
      context: https://github.com/accessmap/accessmap-api.git#develop
    depends_on:
      - api_build
    command: gunicorn -b 0.0.0.0:5555 --access-logfile=- accessmapapi.app:app
    volumes:
      - ${AM_DATADIR:-/docker/amdata}:/www/data
      - ./config/layers.json:/www/layers.json

  webapp:
    build:
      context: https://github.com/accessmap/accessmap-webapp.git#develop
    command: yarn build
    volumes:
      - type: volume
        source: webapp-build
        target: /www/public
        volume:
          nocopy: true
    environment:
      - MAPBOX_TOKEN=${MAPBOX_TOKEN}
      - ANALYTICS_KEY=${ANALYTICS_KEY}
      - OPENID_CLIENT_ID=${OPENID_CLIENT_ID}

  caddy:
    image: abiosoft/caddy:0.10.10
    volumes:
      - type: volume
        source: webapp-build
        target: /webapp
      - ${AM_DATADIR:-/docker/amdata}:/amdata
    links:
      - api
      - rakam

volumes:
  webapp-build:
