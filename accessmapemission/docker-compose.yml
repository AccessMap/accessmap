version: '3.2'

services:

  rakamdb:
    image: postgres:9.6.1

  rakam:
    build: ./builds/rakam
    depends_on:
      - rakamdb
    environment:
      - WAITFOR=rakamdb:5432

  tippecanoe:
    build: ./builds/tippecanoe
    entrypoint: sh /build_tiles.sh /home/tippecanoe/data
    volumes:
      - ./scripts/build_tiles.sh:/build_tiles.sh
      - ${DATADIR:-/docker/accessmapemission_data}:/home/tippecanoe/data

  api_build:
    build:
      context: https://github.com/accessmap/accessmap-api.git#study/emission
    command: python build.py
    volumes:
      - ${DATADIR:-/docker/accessmapemission_data}:/www/data
      - ./config/layers.json:/www/layers.json

  api:
    build:
      context: https://github.com/accessmap/accessmap-api.git#study/emission
    depends_on:
      - api_build
    command: gunicorn -b 0.0.0.0:5555 --access-logfile=- accessmapapi.app:app
    volumes:
      - ${DATADIR:-/docker/accessmapemission_data}:/www/data
      - ./config/layers.json:/www/layers.json

  webapp:
    build:
      context: https://github.com/accessmap/accessmap-webapp.git#study/emission
    command: yarn build
    volumes:
      - type: volume
        source: webapp-build
        target: /www/public
        volume:
          nocopy: true
    environment:
      - MAPBOX_TOKEN=${MAPBOX_TOKEN}
      - ANALYTICS_KEY=${ANALYTICS_KEY}
      - OPENID_CLIENT_ID=${OPENID_CLIENT_ID}

  caddy:
    image: abiosoft/caddy:0.10.10
    volumes:
      - type: volume
        source: webapp-build
        target: /webapp
      - ${DATADIR:-/docker/accessmapemission_data}:/amdata
    links:
      - api
      - rakam

volumes:
  webapp-build:
